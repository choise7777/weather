import streamlit as st
import requests
import json
from datetime import datetime
import pandas as pd
import os
from pathlib import Path

# API í‚¤ ë³´ì•ˆ ë¡œë”©
try:
    # Streamlit Secretsì—ì„œ API í‚¤ ë¡œë”© (ìš°ì„ ìˆœìœ„ 1)
    API_KEY = st.secrets["OPENWEATHER_API_KEY"]
except (KeyError, FileNotFoundError):
    try:
        # .env íŒŒì¼ì—ì„œ í™˜ê²½ë³€ìˆ˜ ë¡œë”© ì‹œë„ (ìš°ì„ ìˆœìœ„ 2)
        from dotenv import load_dotenv
        load_dotenv()
        API_KEY = os.getenv('OPENWEATHER_API_KEY')
        
        # .env íŒŒì¼ì´ ì—†ìœ¼ë©´ config.pyì—ì„œ ë¡œë”©
        if not API_KEY:
            from config import OPENWEATHER_API_KEY
            API_KEY = OPENWEATHER_API_KEY
    except (ImportError, ModuleNotFoundError):
        try:
            # config.pyì—ì„œ ì§ì ‘ ë¡œë”© (ìš°ì„ ìˆœìœ„ 3)
            from config import OPENWEATHER_API_KEY
            API_KEY = OPENWEATHER_API_KEY
        except (ImportError, ModuleNotFoundError):
            # ë§ˆì§€ë§‰ ìˆ˜ë‹¨ìœ¼ë¡œ í•˜ë“œì½”ë”©ëœ í‚¤ ì‚¬ìš© (ê°œë°œìš©)
            API_KEY = "14e3fc348b3e11a20c23806f1c3be844"
            st.warning("âš ï¸ API í‚¤ê°€ ë³´ì•ˆ íŒŒì¼ì—ì„œ ë¡œë”©ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. secrets.toml ë˜ëŠ” config.py íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.")

def get_detailed_address(latitude, longitude):
    """Nominatim APIë¥¼ ì‚¬ìš©í•´ ì¢Œí‘œë¡œë¶€í„° ìƒì„¸ ì£¼ì†Œ ì •ë³´ íšë“"""
    try:
        # Nominatim API (OpenStreetMapì˜ ë¬´ë£Œ ì§€ì˜¤ì½”ë”© ì„œë¹„ìŠ¤)
        nominatim_url = f"https://nominatim.openstreetmap.org/reverse"
        params = {
            'lat': latitude,
            'lon': longitude,
            'format': 'json',
            'accept-language': 'ko,en',  # í•œêµ­ì–´ ìš°ì„ , ì˜ì–´ fallback
            'zoom': 18  # ìƒì„¸í•œ ì£¼ì†Œ ì •ë³´ ìš”ì²­
        }
        
        headers = {
            'User-Agent': 'WeatherApp/1.0 (contact@example.com)'  # Nominatim ì •ì±…ìƒ í•„ìˆ˜
        }
        
        response = requests.get(nominatim_url, params=params, headers=headers, timeout=5)
        
        if response.status_code == 200:
            data = response.json()
            
            # ì£¼ì†Œ ì •ë³´ íŒŒì‹±
            address = data.get('address', {})
            display_name = data.get('display_name', '')
            
            # í•œêµ­ ì£¼ì†Œ ì²´ê³„ì— ë§ê²Œ ì •ë³´ ì¶”ì¶œ
            location_info = {
                'country': address.get('country', ''),
                'state': address.get('state', ''),  # ì‹œ/ë„
                'city': address.get('city', '') or address.get('county', ''),  # ì‹œ/êµ°
                'district': address.get('district', '') or address.get('borough', ''),  # êµ¬
                'neighbourhood': address.get('neighbourhood', '') or address.get('suburb', ''),  # ë™/ë©´
                'road': address.get('road', ''),  # ë„ë¡œëª…
                'house_number': address.get('house_number', ''),
                'full_address': display_name
            }
            
            # í•œêµ­ì–´ ì£¼ì†Œ í¬ë§·íŒ…
            formatted_parts = []
            
            if location_info['country']:
                formatted_parts.append(location_info['country'])
            if location_info['state']:
                formatted_parts.append(location_info['state'])
            if location_info['city']:
                formatted_parts.append(location_info['city'])
            if location_info['district']:
                formatted_parts.append(location_info['district'])
            if location_info['neighbourhood']:
                formatted_parts.append(location_info['neighbourhood'])
                
            location_info['formatted_address'] = ' '.join(formatted_parts)
            
            return location_info
            
    except Exception as e:
        print(f"Nominatim API ì˜¤ë¥˜: {e}")
        return None
    
    return None

def get_ootd_recommendation(feels_like, weather_main):
    """
    ì²´ê° ì˜¨ë„ì™€ ë‚ ì”¨ ìƒíƒœì— ë”°ë¼ ì˜·ì°¨ë¦¼ì„ ì¶”ì²œí•˜ëŠ” í•¨ìˆ˜ (ë°ì´í„° ì²˜ë¦¬)
    'level'ì„ ì¶”ê°€í•˜ì—¬ ê¸°ì˜¨ ë‹¨ê³„ë¥¼ ë¹„êµí•  ìˆ˜ ìˆê²Œ í•¨
    """
    
    if feels_like > 27:
        rec = {
            "level": 8,  # ë¥ë‹¤
            "summary": "ğŸ¥µ ë§¤ìš° ë”ì›€",
            "items": "ë¯¼ì†Œë§¤, ë°˜íŒ”, ë°˜ë°”ì§€, ë¦°ë„¨, ì›í”¼ìŠ¤",
            "image_path": "images/ootd_hot.png"
        }
    elif 23 <= feels_like <= 27:
        rec = {
            "level": 7,
            "summary": "ğŸ˜ ë”ì›€",
            "items": "ë°˜íŒ”, ì–‡ì€ ì…”ì¸ , ë°˜ë°”ì§€, ë©´ë°”ì§€",
            "image_path": "images/ootd_warm.png"
        }
    elif 20 <= feels_like <= 22:
        rec = {
            "level": 6,
            "summary": "ğŸ™‚ ì¾Œì í•¨",
            "items": "ì–‡ì€ ê°€ë””ê±´, ê¸´íŒ” ì…”ì¸ , ë©´ë°”ì§€, ì²­ë°”ì§€",
            "image_path": "images/ootd_mild.png"
        }
    elif 17 <= feels_like <= 19:
        rec = {
            "level": 5,
            "summary": "ğŸ‘ ì„ ì„ í•¨",
            "items": "ë§¨íˆ¬ë§¨, í›„ë“œí‹°, ì–‡ì€ ë‹ˆíŠ¸, ì²­ë°”ì§€",
            "image_path": "images/ootd_cool.png"
        }
    elif 12 <= feels_like <= 16:
        rec = {
            "level": 4,
            "summary": "ğŸ§¥ ìŒ€ìŒ€í•¨",
            "items": "ìì¼“, ê°€ë””ê±´, ë‹ˆíŠ¸, ìŠ¤íƒ€í‚¹, ê¸°ëª¨ ë°”ì§€",
            "image_path": "images/ootd_chilly.png"
        }
    elif 9 <= feels_like <= 11:
        rec = {
            "level": 3,
            "summary": "ğŸ¥¶ ì¶”ì›€",
            "items": "íŠ¸ë Œì¹˜ ì½”íŠ¸, ì•¼ìƒ, ë‹ˆíŠ¸, íˆíŠ¸í…",
            "image_path": "images/ootd_cold.png"
        }
    elif 5 <= feels_like <= 8:
        rec = {
            "level": 2,
            "summary": "â„ï¸ ë§¤ìš° ì¶”ì›€",
            "items": "ìš¸ ì½”íŠ¸, ê°€ì£½ ìì¼“, ëª©ë„ë¦¬, ê¸°ëª¨",
            "image_path": "images/ootd_very_cold.png"
        }
    else:  # 5ë„ ë¯¸ë§Œ
        rec = {
            "level": 1,
            "summary": "ğŸ¥¶ğŸ¥¶ í•œíŒŒ",
            "items": "íŒ¨ë”©, ë‘êº¼ìš´ ì½”íŠ¸, ë‚´ë³µ, ëª©ë„ë¦¬, ì¥ê°‘",
            "image_path": "images/ootd_freezing.png"
        }

    # ë‚ ì”¨ë³„ ì•¡ì„¸ì„œë¦¬ ì¶”ì²œ
    accessory_rec = ""
    if weather_main == "Rain":
        accessory_rec = "â˜” ìš°ì‚°ì„ ê¼­ ì±™ê¸°ì„¸ìš”! ë°©ìˆ˜ ì‹ ë°œë„ ì¢‹ìŠµë‹ˆë‹¤."
    elif weather_main == "Snow":
        accessory_rec = "â„ï¸ ë¯¸ë„ëŸ¼ ë°©ì§€ ì‹ ë°œê³¼ ì¥ê°‘ì„ ì¤€ë¹„í•˜ì„¸ìš”."
    elif weather_main == "Thunderstorm":
        accessory_rec = "âš¡ ìš°ì‚°ê³¼ ë°©ìˆ˜ ì™¸íˆ¬ë¥¼ ì±™ê¸°ì„¸ìš”."
    elif weather_main == "Drizzle":
        accessory_rec = "ğŸŒ¦ï¸ ê°€ë²¼ìš´ ìš°ì‚°ì´ë‚˜ í›„ë“œë¥¼ ì¤€ë¹„í•˜ì„¸ìš”."
    elif weather_main == "Mist" or weather_main == "Fog":
        accessory_rec = "ğŸŒ«ï¸ ì‹œì•¼ í™•ë³´ë¥¼ ìœ„í•´ ë°ì€ ìƒ‰ ì˜·ì„ ê¶Œí•©ë‹ˆë‹¤."
    elif weather_main == "Clear" and feels_like > 25:
        accessory_rec = "ğŸ•¶ï¸ ì„ ê¸€ë¼ìŠ¤ì™€ ìì™¸ì„  ì°¨ë‹¨ì œë¥¼ ì¤€ë¹„í•˜ì„¸ìš”."
    elif weather_main == "Clouds" and feels_like < 15:
        accessory_rec = "â˜ï¸ ì²´ì˜¨ ìœ ì§€ë¥¼ ìœ„í•´ ëª©ë„ë¦¬ë¥¼ ì±™ê¸°ì„¸ìš”."
    
    return rec, accessory_rec

def set_background(weather_main):
    """ë‚ ì”¨ ìƒíƒœì— ë”°ë¼ ë™ì  ë°°ê²½í™”ë©´ ì„¤ì •"""
    # ë‚ ì”¨ ìƒíƒœì— ë”°ë¼ ë‹¤ë¥¸ ì´ë¯¸ì§€ URLì„ ë§¤í•‘
    if weather_main == "Clear":
        bg_url = "https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80"  # ë§‘ì€ í•˜ëŠ˜
    elif weather_main == "Rain":
        bg_url = "https://images.unsplash.com/photo-1515694346937-94d85e41e6f0?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2127&q=80"  # ë¹„ ì˜¤ëŠ” ì°½ë¬¸
    elif weather_main == "Snow":
        bg_url = "https://images.unsplash.com/photo-1548777123-93d6ac74e765?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80"  # ëˆˆ ë‚´ë¦¬ëŠ” í’ê²½
    elif weather_main == "Clouds":
        bg_url = "https://images.unsplash.com/photo-1534088568595-a066f410bcda?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2051&q=80"  # íë¦° í•˜ëŠ˜
    elif weather_main == "Thunderstorm":
        bg_url = "https://images.unsplash.com/photo-1605727216801-e27ce1d0cc28?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2071&q=80"  # ë²ˆê°œ/ì²œë‘¥
    elif weather_main == "Drizzle":
        bg_url = "https://images.unsplash.com/photo-1541919329513-35f7af297129?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80"  # ì´ìŠ¬ë¹„
    elif weather_main == "Mist" or weather_main == "Fog":
        bg_url = "https://images.unsplash.com/photo-1487621167305-5d248087c724?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2132&q=80"  # ì•ˆê°œ ë‚€ í’ê²½
    else:
        bg_url = "https://images.unsplash.com/photo-1504608524841-42fe6f032b4b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80"  # ê¸°ë³¸ í•˜ëŠ˜ ì´ë¯¸ì§€

    # CSSë¥¼ HTMLë¡œ ì£¼ì…
    st.markdown(
        f"""
        <style>
        .stApp {{
            background-image: url("{bg_url}");
            background-size: cover;
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-position: center;
        }}
        
        /* ì „ì²´ ì•± ì»¨í…Œì´ë„ˆì— ê°•í•œ ë°˜íˆ¬ëª… ë°°ê²½ */
        .stApp > div:first-child {{
            background-color: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px);
            min-height: 100vh;
        }}
        
        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ ë°°ê²½ ê°•í™” */
        .main .block-container {{
            background-color: rgba(255, 255, 255, 0.98) !important;
            padding: 2rem 1rem;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            backdrop-filter: blur(15px);
        }}
        
        /* ë©”íŠ¸ë¦­ ì¹´ë“œ ìŠ¤íƒ€ì¼ ê°œì„  */
        div[data-testid="metric-container"] {{
            background-color: rgba(255, 255, 255, 0.95) !important;
            border: 2px solid rgba(200, 200, 200, 0.5);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }}
        
        /* ë©”íŠ¸ë¦­ í…ìŠ¤íŠ¸ ê°•í™” */
        div[data-testid="metric-container"] * {{
            color: #333333 !important;
            font-weight: 600 !important;
        }}
        
        /* í™•ì¥ ê°€ëŠ¥í•œ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        div[data-testid="stExpander"] {{
            background-color: rgba(255, 255, 255, 0.95) !important;
            border-radius: 12px;
            border: 1px solid rgba(200, 200, 200, 0.5);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }}
        
        /* íƒ­ ìŠ¤íƒ€ì¼ ê°œì„  */
        .stTabs [data-baseweb="tab-list"] {{
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 5px;
        }}
        
        .stTabs [data-baseweb="tab"] {{
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            margin: 2px;
        }}
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ ê°œì„  */
        .stButton > button {{
            background-color: rgba(255, 255, 255, 0.9) !important;
            color: #333333 !important;
            border: 2px solid rgba(103, 126, 234, 0.8) !important;
            font-weight: 600 !important;
        }}
        
        .stButton > button:hover {{
            background-color: rgba(103, 126, 234, 0.9) !important;
            color: white !important;
        }}
        
        /* ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ ê°œì„  */
        .stTextInput > div > div > input {{
            background-color: rgba(255, 255, 255, 0.95) !important;
            color: #333333 !important;
            border: 2px solid rgba(200, 200, 200, 0.7) !important;
        }}
        
        /* ìˆ«ì ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ ê°œì„  */
        .stNumberInput > div > div > input {{
            background-color: rgba(255, 255, 255, 0.95) !important;
            color: #333333 !important;
            border: 2px solid rgba(200, 200, 200, 0.7) !important;
        }}
        
        /* ë°ì´í„°í”„ë ˆì„ ìŠ¤íƒ€ì¼ ê°œì„  */
        .stDataFrame {{
            background-color: rgba(255, 255, 255, 0.95) !important;
            border-radius: 10px;
            overflow: hidden;
        }}
        
        /* ì°¨íŠ¸ ë°°ê²½ ê°œì„  */
        .stPlotlyChart {{
            background-color: rgba(255, 255, 255, 0.95) !important;
            border-radius: 10px;
            padding: 10px;
        }}
        
        /* ì¼ë°˜ í…ìŠ¤íŠ¸ ê°€ë…ì„± í–¥ìƒ */
        .stMarkdown, .stText, p, div {{
            color: #333333 !important;
        }}
        
        /* ì œëª© ìŠ¤íƒ€ì¼ ê°•í™” */
        h1, h2, h3, h4, h5, h6 {{
            color: #2c3e50 !important;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
        }}
        </style>
        """,
        unsafe_allow_html=True
    )

# OpenWeather API ì„¤ì •
BASE_URL = "http://api.openweathermap.org/data/2.5/weather"
FORECAST_URL = "http://api.openweathermap.org/data/2.5/forecast"

# í˜ì´ì§€ ì„¤ì • - ì „ ë²„ì „ ë””ìì¸ìœ¼ë¡œ ë¡¤ë°±
st.set_page_config(
    page_title="ğŸŒ¤ï¸ ì‹¤ì‹œê°„ ë‚ ì”¨",
    page_icon="ğŸŒ¤ï¸",
    layout="centered",  # wideì—ì„œ centeredë¡œ ë³€ê²½
    initial_sidebar_state="auto"
)

# CSSë¡œ ë¶ˆí•„ìš”í•œ ìš”ì†Œ ìˆ¨ê¸°ê¸°
st.markdown("""
<style>
    .stDeployButton {display:none;}
    footer {visibility: hidden;}
    .stDecoration {display:none;}
    header {visibility: hidden;}
    .css-1rs6os {display:none;}
    .css-17eq0hr {display:none;}
</style>
""", unsafe_allow_html=True)

def get_weather_data(city_name, country_code=None):
    """í˜„ì¬ ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜"""
    if country_code:
        query = f"{city_name},{country_code}"
    else:
        query = city_name
    
    params = {
        'q': query,
        'appid': API_KEY,
        'units': 'metric',  # ì„­ì”¨ ì˜¨ë„
        'lang': 'kr'  # í•œêµ­ì–´
    }
    
    try:
        response = requests.get(BASE_URL, params=params)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.RequestException as e:
        st.error(f"ë‚ ì”¨ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: {e}")
        return None

def get_forecast_data(city_name, country_code=None):
    """5ì¼ ë‚ ì”¨ ì˜ˆë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜"""
    if country_code:
        query = f"{city_name},{country_code}"
    else:
        query = city_name
    
    params = {
        'q': query,
        'appid': API_KEY,
        'units': 'metric',
        'lang': 'kr'
    }
    
    try:
        response = requests.get(FORECAST_URL, params=params)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.RequestException as e:
        st.error(f"ì˜ˆë³´ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: {e}")
        return None

def get_weather_by_coordinates(lat, lon):
    """ìœ„ë„/ê²½ë„ë¡œ í˜„ì¬ ë‚ ì”¨ ê°€ì ¸ì˜¤ê¸°"""
    params = {
        'lat': lat,
        'lon': lon,
        'appid': API_KEY,
        'units': 'metric',
        'lang': 'kr'
    }
    
    try:
        response = requests.get(BASE_URL, params=params)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.RequestException as e:
        st.error(f"ìœ„ì¹˜ ê¸°ë°˜ ë‚ ì”¨ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: {e}")
        return None

def get_forecast_by_coordinates(lat, lon):
    """ìœ„ë„/ê²½ë„ë¡œ ì˜ˆë³´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°"""
    params = {
        'lat': lat,
        'lon': lon,
        'appid': API_KEY,
        'units': 'metric',
        'lang': 'kr'
    }
    
    try:
        response = requests.get(FORECAST_URL, params=params)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.RequestException as e:
        st.error(f"ìœ„ì¹˜ ê¸°ë°˜ ì˜ˆë³´ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: {e}")
        return None

def process_weekly_forecast(forecast_data):
    """ì£¼ê°„ ì˜ˆë³´ ë°ì´í„° ì²˜ë¦¬"""
    if not forecast_data or 'list' not in forecast_data:
        return []
    
    weekly_data = []
    daily_data = {}
    
    # 5ì¼ ì˜ˆë³´ë¥¼ ì¼ë³„ë¡œ ê·¸ë£¹í™”
    for item in forecast_data['list']:
        date = datetime.fromtimestamp(item['dt'])
        date_key = date.strftime('%Y-%m-%d')
        
        if date_key not in daily_data:
            daily_data[date_key] = {
                'temps': [],
                'humidity': [],
                'weather': item['weather'][0]['description'],
                'pop': item.get('pop', 0),
                'date': date,
                'wind_speeds': []
            }
        
        daily_data[date_key]['temps'].append(item['main']['temp'])
        daily_data[date_key]['humidity'].append(item['main']['humidity'])
        daily_data[date_key]['wind_speeds'].append(item['wind'].get('speed', 0))
    
    # ì¼ë³„ ë°ì´í„°ë¥¼ ì •ë¦¬í•˜ì—¬ ì£¼ê°„ ë°ì´í„° ìƒì„±
    for date_key, data in list(daily_data.items())[:7]:  # ìµœëŒ€ 7ì¼
        weekly_data.append({
            'ë‚ ì§œ': data['date'].strftime('%m/%d (%a)'),
            'ë‚ ì”¨': data['weather'],
            'ìµœê³ ì˜¨ë„': f"{max(data['temps']):.0f}Â°C",
            'ìµœì €ì˜¨ë„': f"{min(data['temps']):.0f}Â°C",
            'í‰ê· ìŠµë„': f"{sum(data['humidity'])//len(data['humidity'])}%",
            'í‰ê· í’ì†': f"{sum(data['wind_speeds'])/len(data['wind_speeds']):.1f} m/s",
            'ê°•ìˆ˜í™•ë¥ ': f"{data['pop']*100:.0f}%"
        })
    
    return weekly_data

def display_current_weather(weather_data):
    """í˜„ì¬ ë‚ ì”¨ ì •ë³´ í‘œì‹œ"""
    # ë‚ ì”¨ ì •ë³´ë¥¼ 3ê°œ ì»¬ëŸ¼ìœ¼ë¡œ í‘œì‹œ
    col1, col2, col3 = st.columns(3)
    
    with col1:
        temp = weather_data['main']['temp']
        st.metric(
            label="ğŸŒ¡ï¸ ì˜¨ë„", 
            value=f"{temp:.1f}Â°C",
            delta=f"ì²´ê° {weather_data['main']['feels_like']:.1f}Â°C"
        )
    
    with col2:
        humidity = weather_data['main']['humidity']
        st.metric(
            label="ğŸ’§ ìŠµë„", 
            value=f"{humidity}%"
        )
    
    with col3:
        wind_speed = weather_data['wind']['speed']
        st.metric(
            label="ğŸ’¨ í’ì†", 
            value=f"{wind_speed:.1f} m/s"
        )
    
    # ë‚ ì”¨ ìƒíƒœ
    weather_desc = weather_data['weather'][0]['description']
    weather_icon = weather_data['weather'][0]['icon']
    
    st.markdown(f"""
    <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
         border-radius: 10px; color: white; margin: 20px 0;">
        <h3>â˜ï¸ {weather_desc.title()}</h3>
        <p style="font-size: 18px; margin: 0;">í˜„ì¬ ë‚ ì”¨ ìƒíƒœ</p>
    </div>
    """, unsafe_allow_html=True)

def display_city_weather(search_btn, city_input):
    """ë„ì‹œ ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ"""
    if search_btn and city_input:
        with st.spinner("ë‚ ì”¨ ì •ë³´ ë¡œë”©ì¤‘..."):
            weather_data = get_weather_data(city_input)
            
            if weather_data:
                # ë‚ ì”¨ì— ë”°ë¥¸ ë™ì  ë°°ê²½í™”ë©´ ì„¤ì •
                set_background(weather_data['weather'][0]['main'])
                
                # ê¸°ë³¸ ì •ë³´
                st.success(f"ğŸ“ {weather_data['name']}, {weather_data['sys']['country']}")
                
                # í˜„ì¬ ë‚ ì”¨ í‘œì‹œ
                st.subheader("ğŸŒ¡ï¸ í˜„ì¬ ë‚ ì”¨")
                display_current_weather(weather_data)
                
                # ìƒì„¸ ì •ë³´
                with st.expander("ğŸ“Š ìƒì„¸ ì •ë³´ ë³´ê¸°"):
                    detail_col1, detail_col2 = st.columns(2)
                    
                    with detail_col1:
                        st.write(f"**ì²´ê°ì˜¨ë„:** {weather_data['main']['feels_like']:.1f}Â°C")
                        st.write(f"**ìµœê³ ì˜¨ë„:** {weather_data['main']['temp_max']:.1f}Â°C")
                        st.write(f"**ìµœì €ì˜¨ë„:** {weather_data['main']['temp_min']:.1f}Â°C")
                        st.write(f"**ê¸°ì••:** {weather_data['main']['pressure']} hPa")
                    
                    with detail_col2:
                        st.write(f"**êµ¬ë¦„ëŸ‰:** {weather_data['clouds']['all']}%")
                        st.write(f"**ê°€ì‹œê±°ë¦¬:** {weather_data.get('visibility', 0)/1000:.1f} km")
                        
                        # ì¼ì¶œ/ì¼ëª°
                        sunrise = datetime.fromtimestamp(weather_data['sys']['sunrise'])
                        sunset = datetime.fromtimestamp(weather_data['sys']['sunset'])
                        st.write(f"**ì¼ì¶œ:** {sunrise.strftime('%H:%M')}")
                        st.write(f"**ì¼ëª°:** {sunset.strftime('%H:%M')}")
                
                # ì˜ˆë³´ ê·¸ë˜í”„ (ê°„ë‹¨í•˜ê²Œ)
                forecast_data = get_forecast_data(city_input)
                if forecast_data:
                    display_forecast(forecast_data)
            
            else:
                st.error("âŒ ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë„ì‹œëª…ì„ í™•ì¸í•´ì£¼ì„¸ìš”.")
    
    elif not search_btn:
        st.info("ğŸ‘† ìœ„ì—ì„œ ë„ì‹œëª…ì„ ì…ë ¥í•˜ê±°ë‚˜ ì¸ê¸° ë„ì‹œ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”!")

def display_location_weather():
    """í˜„ì¬ ìœ„ì¹˜ ê¸°ë°˜ ë‚ ì”¨ í‘œì‹œ"""
    st.markdown("### ğŸ“ í˜„ì¬ ìœ„ì¹˜ ê¸°ë°˜ ë‚ ì”¨")
    
    # ì¢Œí‘œ ì…ë ¥
    col1, col2, col3 = st.columns([1, 1, 1])
    
    with col1:
        latitude = st.number_input("ìœ„ë„ (Latitude)", value=37.6199671, format="%.6f")
    
    with col2:
        longitude = st.number_input("ê²½ë„ (Longitude)", value=126.726365, format="%.6f")
    
    with col3:
        location_search = st.button("ğŸ¯ í˜„ì¬ ìœ„ì¹˜ ë‚ ì”¨", type="primary")
    
    # ìœ„ì¹˜ ê¸°ë°˜ ë‚ ì”¨ ê²°ê³¼ í‘œì‹œ
    if location_search:
        with st.spinner("í˜„ì¬ ìœ„ì¹˜ì˜ ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."):
            weather_data = get_weather_by_coordinates(latitude, longitude)
            
            if weather_data:
                # ë‚ ì”¨ì— ë”°ë¥¸ ë™ì  ë°°ê²½í™”ë©´ ì„¤ì •
                set_background(weather_data['weather'][0]['main'])
                
                # ìƒì„¸ ì£¼ì†Œ ì •ë³´ íšë“
                detailed_address = get_detailed_address(latitude, longitude)
                
                # ìœ„ì¹˜ ì •ë³´ í‘œì‹œ
                if detailed_address and detailed_address['formatted_address']:
                    location_display = f"ğŸ“ **ìƒì„¸ ìœ„ì¹˜:** {detailed_address['formatted_address']}"
                    weather_location = f"**ë‚ ì”¨ ê¸°ì¤€:** {weather_data['name']}, {weather_data['sys']['country']}"
                    st.success(location_display)
                    st.info(f"ğŸŒ¤ï¸ {weather_location} | ğŸ“ ìœ„ë„: {latitude:.4f}, ê²½ë„: {longitude:.4f}")
                    
                    # ìƒì„¸ ì£¼ì†Œ ì •ë³´ë¥¼ í™•ì¥ ê°€ëŠ¥í•œ ì„¹ì…˜ìœ¼ë¡œ í‘œì‹œ
                    with st.expander("ğŸ—ºï¸ ìƒì„¸ ìœ„ì¹˜ ì •ë³´ ë³´ê¸°"):
                        addr_col1, addr_col2 = st.columns(2)
                        
                        with addr_col1:
                            if detailed_address['country']:
                                st.write(f"**ğŸŒ êµ­ê°€:** {detailed_address['country']}")
                            if detailed_address['state']:
                                st.write(f"**ğŸ›ï¸ ì‹œ/ë„:** {detailed_address['state']}")
                            if detailed_address['city']:
                                st.write(f"**ğŸ™ï¸ ì‹œ/êµ°:** {detailed_address['city']}")
                        
                        with addr_col2:
                            if detailed_address['district']:
                                st.write(f"**ğŸ˜ï¸ êµ¬:** {detailed_address['district']}")
                            if detailed_address['neighbourhood']:
                                st.write(f"**ğŸ  ë™/ë©´:** {detailed_address['neighbourhood']}")
                            if detailed_address['road']:
                                st.write(f"**ğŸ›£ï¸ ë„ë¡œ:** {detailed_address['road']}")
                
                else:
                    # Nominatim API ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ì •ë³´ í‘œì‹œ
                    st.success(f"ğŸ“ {weather_data['name']}, {weather_data['sys']['country']}")
                    st.info(f"ğŸ“ ìœ„ë„: {latitude:.4f}, ê²½ë„: {longitude:.4f}")
                    st.warning("âš ï¸ ìƒì„¸ ì£¼ì†Œ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì–´ ë‚ ì”¨ ê¸°ì¤€ ìœ„ì¹˜ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.")
                
                st.subheader("ğŸŒ¡ï¸ í˜„ì¬ ë‚ ì”¨")
                display_current_weather(weather_data)
                
                # ìƒì„¸ ì •ë³´
                with st.expander("ğŸ“Š ìƒì„¸ ì •ë³´ ë³´ê¸°"):
                    detail_col1, detail_col2 = st.columns(2)
                    
                    with detail_col1:
                        st.write(f"**ì²´ê°ì˜¨ë„:** {weather_data['main']['feels_like']:.1f}Â°C")
                        st.write(f"**ìµœê³ ì˜¨ë„:** {weather_data['main']['temp_max']:.1f}Â°C")
                        st.write(f"**ìµœì €ì˜¨ë„:** {weather_data['main']['temp_min']:.1f}Â°C")
                        st.write(f"**ê¸°ì••:** {weather_data['main']['pressure']} hPa")
                    
                    with detail_col2:
                        st.write(f"**êµ¬ë¦„ëŸ‰:** {weather_data['clouds']['all']}%")
                        st.write(f"**ê°€ì‹œê±°ë¦¬:** {weather_data.get('visibility', 0)/1000:.1f} km")
                        
                        # ì¼ì¶œ/ì¼ëª°
                        sunrise = datetime.fromtimestamp(weather_data['sys']['sunrise'])
                        sunset = datetime.fromtimestamp(weather_data['sys']['sunset'])
                        st.write(f"**ì¼ì¶œ:** {sunrise.strftime('%H:%M')}")
                        st.write(f"**ì¼ëª°:** {sunset.strftime('%H:%M')}")
                
                # ì£¼ê°„ ì˜ˆë³´
                st.divider()
                forecast_data = get_forecast_by_coordinates(latitude, longitude)
                if forecast_data:
                    weekly_data = process_weekly_forecast(forecast_data)
                    
                    if weekly_data:
                        st.subheader("ğŸ“… ì£¼ê°„ ë‚ ì”¨ ì˜ˆë³´ (7ì¼)")
                        
                        # ì£¼ê°„ ì˜ˆë³´ ë°ì´í„°í”„ë ˆì„
                        weekly_df = pd.DataFrame(weekly_data)
                        st.dataframe(weekly_df, use_container_width=True)
                        
                        # ì£¼ê°„ ì˜¨ë„ ë³€í™” ì°¨íŠ¸
                        st.subheader("ğŸ“Š ì£¼ê°„ ì˜¨ë„ ë³€í™”")
                        
                        # ì˜¨ë„ ë°ì´í„° ì¶”ì¶œ
                        chart_data = []
                        for item in weekly_data:
                            max_temp = float(item['ìµœê³ ì˜¨ë„'].replace('Â°C', ''))
                            min_temp = float(item['ìµœì €ì˜¨ë„'].replace('Â°C', ''))
                            chart_data.append({
                                'ë‚ ì§œ': item['ë‚ ì§œ'],
                                'ìµœê³ ì˜¨ë„': max_temp,
                                'ìµœì €ì˜¨ë„': min_temp
                            })
                        
                        chart_df = pd.DataFrame(chart_data).set_index('ë‚ ì§œ')
                        st.line_chart(chart_df)
                    
                    st.divider()  # êµ¬ë¶„ì„  ì¶”ê°€
                    
                    # OOTD íƒ€ì„ë¼ì¸
                    display_hourly_ootd_timeline(forecast_data)
                    
                    st.divider()  # êµ¬ë¶„ì„  ì¶”ê°€
                    
                    # 2ì¼ê°„ ìƒì„¸ ê·¸ë˜í”„ (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)
                    display_forecast(forecast_data)
            
            else:
                st.error("âŒ í˜„ì¬ ìœ„ì¹˜ì˜ ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    
    else:
        st.markdown("""
        ### ğŸ’¡ ì‚¬ìš©ë²•
        **í˜„ì¬ ìœ„ì¹˜ ê¸°ë°˜ ë‚ ì”¨ ì¡°íšŒ:**
        1. **ìœ„ë„/ê²½ë„ ì…ë ¥** í›„ 'ğŸ¯ í˜„ì¬ ìœ„ì¹˜ ë‚ ì”¨' í´ë¦­
        2. ë˜ëŠ” **ì£¼ìš” ë„ì‹œ ì¢Œí‘œ ë²„íŠ¼** í´ë¦­
        3. **ì£¼ê°„ ì˜ˆë³´** ë° **ì˜¨ë„ ë³€í™” ì°¨íŠ¸** í™•ì¸
        
        ### ğŸ—“ï¸ ì£¼ê°„ ì˜ˆë³´ ê¸°ëŠ¥
        - **7ì¼ ë‚ ì”¨ ì˜ˆë³´**: ì¼ë³„ ìµœê³ /ìµœì € ì˜¨ë„
        - **ìƒì„¸ ì •ë³´**: ë‚ ì”¨, ìŠµë„, í’ì†, ê°•ìˆ˜í™•ë¥ 
        - **ì˜¨ë„ ì°¨íŠ¸**: ì£¼ê°„ ì˜¨ë„ ë³€í™” ì‹œê°í™”
        - **2ì¼ ìƒì„¸**: 48ì‹œê°„ ì˜¨ë„/ìŠµë„/í’ì† ê·¸ë˜í”„
        
        ### ğŸ“ ì¢Œí‘œ ì˜ˆì‹œ
        - **ê¹€í¬ ì‚¬ìš°ë™**: 37.6199671, 126.726365
        - **ì„œìš¸**: 37.5665, 126.9780
        - **ë¶€ì‚°**: 35.1796, 129.0756  
        - **ì œì£¼**: 33.4996, 126.5312
        """)

def display_current_weather(weather_data):
    """í˜„ì¬ ë‚ ì”¨ ì •ë³´ë¥¼ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜"""
    if weather_data:
        col1, col2, col3 = st.columns(3)
        
        with col1:
            st.metric(
                label="ğŸŒ¡ï¸ ì˜¨ë„",
                value=f"{weather_data['main']['temp']:.1f}Â°C",
                delta=f"ì²´ê°ì˜¨ë„: {weather_data['main']['feels_like']:.1f}Â°C"
            )
        
        with col2:
            st.metric(
                label="ğŸ’§ ìŠµë„",
                value=f"{weather_data['main']['humidity']}%"
            )
        
        with col3:
            st.metric(
                label="ğŸ‘ï¸ ê°€ì‹œê±°ë¦¬",
                value=f"{weather_data.get('visibility', 0)/1000:.1f}km"
            )
        
        # ì¶”ê°€ ì •ë³´
        col4, col5, col6 = st.columns(3)
        
        with col4:
            st.metric(
                label="ğŸŒ¬ï¸ í’ì†",
                value=f"{weather_data['wind'].get('speed', 0)} m/s"
            )
        
        with col5:
            st.metric(
                label="ğŸŒ¡ï¸ ê¸°ì••",
                value=f"{weather_data['main']['pressure']} hPa"
            )
        
        with col6:
            st.metric(
                label="ğŸŒ¤ï¸ ë‚ ì”¨",
                value=weather_data['weather'][0]['description']
            )

def display_forecast(forecast_data):
    """5ì¼ ë‚ ì”¨ ì˜ˆë³´ë¥¼ ê·¸ë˜í”„ë¡œ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜"""
    if forecast_data:
        # --- ê·¸ë˜í”„ë¡œ ë³€ê²½ ---
        # 'ì‹œê°„'ì„ ì¸ë±ìŠ¤ë¡œ, 'ì˜¨ë„'ë¥¼ ê°’ìœ¼ë¡œ í•˜ëŠ” ìƒˆ DataFrame ìƒì„±
        chart_data_list = []
        for item in forecast_data['list'][:16]:  # 2ì¼ì¹˜(16*3=48ì‹œê°„) ì •ë„ë§Œ
            chart_data_list.append({
                'ì‹œê°„': datetime.fromtimestamp(item['dt']),
                'ì˜¨ë„': item['main']['temp']
            })

        chart_df = pd.DataFrame(chart_data_list).set_index('ì‹œê°„')

        st.subheader("ğŸŒ¡ï¸ 2ì¼ê°„ ê¸°ì˜¨ ë³€í™”")
        st.line_chart(chart_df)
        
        # ì¶”ê°€: ìŠµë„ì™€ í’ì† ê·¸ë˜í”„
        st.subheader("ï¿½ 2ì¼ê°„ ìŠµë„ ë° ğŸŒ¬ï¸ í’ì† ë³€í™”")
        
        # ìŠµë„ì™€ í’ì† ë°ì´í„° ì¤€ë¹„
        multi_data_list = []
        for item in forecast_data['list'][:16]:
            multi_data_list.append({
                'ì‹œê°„': datetime.fromtimestamp(item['dt']),
                'ìŠµë„(%)': item['main']['humidity'],
                'í’ì†(m/s)': item['wind'].get('speed', 0)
            })
        
        multi_df = pd.DataFrame(multi_data_list).set_index('ì‹œê°„')
        st.line_chart(multi_df)
        
        # ìƒì„¸ ë°ì´í„° í‘œ (ì ‘ì„ ìˆ˜ ìˆëŠ” í˜•íƒœë¡œ)
        with st.expander("ğŸ“Š ìƒì„¸ ì˜ˆë³´ ë°ì´í„° ë³´ê¸°"):
            detail_list = []
            for item in forecast_data['list'][:16]:
                date_time = datetime.fromtimestamp(item['dt'])
                detail_list.append({
                    'ë‚ ì§œ': date_time.strftime('%m-%d'),
                    'ì‹œê°„': date_time.strftime('%H:%M'),
                    'ì˜¨ë„': f"{item['main']['temp']:.1f}Â°C",
                    'ë‚ ì”¨': item['weather'][0]['description'],
                    'ìŠµë„': f"{item['main']['humidity']}%",
                    'í’ì†': f"{item['wind'].get('speed', 0):.1f} m/s"
                })
            
            detail_df = pd.DataFrame(detail_list)
            st.dataframe(detail_df, use_container_width=True)



def display_hourly_ootd_timeline(forecast_data):
    """
    ì‹œê°„ëŒ€ë³„ OOTD íƒ€ì„ë¼ì¸ì„ ê°€ë¡œë¡œ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜ (ê°œì„  ë²„ì „)
    """
    st.subheader("ğŸ‘• ì‹œê°„ëŒ€ë³„ 'ì˜¤ëŠ˜ ë­ ì…ì§€?' íƒ€ì„ë¼ì¸")

    # 1. 'ì˜¤ëŠ˜+ë‚´ì¼'ì˜ ì˜ˆë³´ ë°ì´í„° í•„í„°ë§ (ë” ë§ì€ ì‹œê°„ëŒ€)
    now = datetime.now()
    forecasts = []
    
    if 'list' not in forecast_data:
        st.warning("ì‹œê°„ëŒ€ë³„ ì˜ˆë³´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return

    for item in forecast_data['list'][:12]:  # 36ì‹œê°„ (12ê°œ ì‹œê°„ëŒ€)
        item_time = datetime.fromtimestamp(item['dt'])
        # í˜„ì¬ ì‹œê°„ ì´í›„ì˜ ì˜ˆë³´ë§Œ ì„ íƒ
        if item_time >= now:
            forecasts.append(item)
    
    if not forecasts:
        st.info("ì‹œê°„ëŒ€ë³„ ì˜ˆë³´ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.")
        return

    # 2. ê°€ë¡œ íƒ€ì„ë¼ì¸ ìƒì„± (6ê°œë¡œ ì¤„ì—¬ì„œ ë„“ì´ í™•ë³´)
    cols = st.columns(min(len(forecasts), 6))  # ìµœëŒ€ 6ê°œ ì»¬ëŸ¼ìœ¼ë¡œ ì¤„ì„
    
    prev_rec = None  # ì´ì „ ì‹œê°„ëŒ€ ì¶”ì²œì„ ì €ì¥í•  ë³€ìˆ˜

    for i, item in enumerate(forecasts[:6]):  # ìµœëŒ€ 6ê°œ ì‹œê°„ëŒ€ë§Œ í‘œì‹œ
        with cols[i]:
            # ê³ ì • ë†’ì´ ì¹´ë“œ ì»¨í…Œì´ë„ˆ
            st.markdown("""
            <div style="border: 1px solid #e0e0e0; border-radius: 10px; padding: 15px; 
                        height: 400px; background-color: rgba(255, 255, 255, 0.95); 
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin: 10px 0;">
            """, unsafe_allow_html=True)
            
            item_time = datetime.fromtimestamp(item['dt'])
            
            # ë‚ ì”¨ ë°ì´í„° ì¶”ì¶œ
            temp = item['main']['temp']
            feels_like = item['main']['feels_like']
            humidity = item['main']['humidity']
            wind_speed = item['wind'].get('speed', 0)
            weather_main = item['weather'][0]['main']
            weather_desc = item['weather'][0]['description']
            
            # í˜„ì¬ ì‹œê°„ëŒ€ì˜ OOTD ì¶”ì²œ ë°›ê¸°
            current_rec, accessory_rec = get_ootd_recommendation(feels_like, weather_main)

            # (1) ì‹œê°„ í‘œì‹œ - ê³ ì • ë†’ì´
            if item_time.date() == now.date():
                time_str = f"ì˜¤ëŠ˜ {item_time.strftime('%Hì‹œ')}"
            else:
                time_str = f"ë‚´ì¼ {item_time.strftime('%Hì‹œ')}"
            
            st.markdown(f"""
            <div style="text-align: center; font-weight: bold; font-size: 14px; 
                       margin-bottom: 12px; padding: 8px; height: 35px;
                       background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                       border-radius: 8px; color: white; display: flex; align-items: center; justify-content: center;">
                {time_str}
            </div>
            """, unsafe_allow_html=True)
            
            # (2) ë‚ ì”¨ ì •ë³´ - ê³ ì • ë†’ì´
            st.markdown(f"""
            <div style="text-align: center; margin-bottom: 10px; height: 50px; display: flex; flex-direction: column; justify-content: center;">
                <div style="font-weight: bold; font-size: 16px;">ğŸŒ¡ï¸ {temp:.1f}Â°C</div>
                <div style="font-size: 12px; color: #666;">ì²´ê° {feels_like:.1f}Â°C</div>
                <div style="font-size: 11px; color: #888;">ğŸ’§ {humidity}% | ğŸ’¨ {wind_speed:.1f}m/s</div>
            </div>
            """, unsafe_allow_html=True)
            
            # (3) ë³€í™” ê°ì§€ ë° ì¡°ì–¸ - ê³ ì • ë†’ì´
            advice_html = ""
            if prev_rec and current_rec['level'] < prev_rec['level']:
                colder_item = current_rec['items'].split(',')[0].strip()
                advice_html = f"""
                <div style="background-color: rgba(255, 193, 7, 0.2); padding: 6px; border-radius: 6px; 
                           text-align: center; font-size: 11px; font-weight: bold; height: 35px; 
                           display: flex; align-items: center; justify-content: center; margin-bottom: 8px;">
                    â• {colder_item} ì±™ê¸°ì„¸ìš”!
                </div>
                """
            elif prev_rec and current_rec['level'] > prev_rec['level']:
                advice_html = f"""
                <div style="background-color: rgba(144, 202, 249, 0.3); padding: 6px; border-radius: 6px; 
                           text-align: center; font-size: 11px; font-weight: bold; height: 35px; 
                           display: flex; align-items: center; justify-content: center; margin-bottom: 8px;">
                    â˜€ï¸ ë”ì›Œì ¸ìš”. ì™¸íˆ¬ë¥¼ ë²—ìœ¼ì„¸ìš”
                </div>
                """
            else:
                advice_html = '<div style="height: 43px; margin-bottom: 8px;"></div>'
            
            st.markdown(advice_html, unsafe_allow_html=True)

            # (4) ì¶”ì²œ ì˜·ì°¨ë¦¼ ìƒíƒœ - ê³ ì • ë†’ì´
            st.markdown(f"""
            <div style="text-align: center; padding: 8px; height: 35px;
                       background: rgba(103, 126, 234, 0.1); 
                       border-radius: 6px; margin-bottom: 10px; 
                       display: flex; align-items: center; justify-content: center;">
                <strong style="font-size: 12px;">{current_rec['summary']}</strong>
            </div>
            """, unsafe_allow_html=True)
            
            # (5) ì¶”ì²œ ì˜ë¥˜ - ê³ ì • ë†’ì´
            st.markdown(f"""
            <div style="margin-bottom: 8px; height: 80px; overflow: hidden;">
                <div style="font-weight: bold; font-size: 12px; margin-bottom: 4px;">ğŸ‘• ì¶”ì²œ ì˜ë¥˜</div>
                <div style="font-size: 10px; color: #666; line-height: 1.3;">{current_rec['items']}</div>
            </div>
            """, unsafe_allow_html=True)
            
            # (6) ì•¡ì„¸ì„œë¦¬ ì¡°ì–¸ - ê³ ì • ë†’ì´
            accessory_text = accessory_rec if accessory_rec else "íŠ¹ë³„í•œ ì¤€ë¹„ë¬¼ ì—†ìŒ"
            st.markdown(f"""
            <div style="height: 60px; overflow: hidden;">
                <div style="font-weight: bold; font-size: 12px; margin-bottom: 4px;">ğŸ¯ í•„ìˆ˜ ì•„ì´í…œ</div>
                <div style="font-size: 10px; color: #666; line-height: 1.3;">{accessory_text}</div>
            </div>
            """, unsafe_allow_html=True)
            
            # ì»¨í…Œì´ë„ˆ ë‹«ê¸°
            st.markdown("</div>", unsafe_allow_html=True)

            # ë‹¤ìŒ ë£¨í”„ë¥¼ ìœ„í•´ í˜„ì¬ ì¶”ì²œì„ prev_recì— ì €ì¥
            prev_rec = current_rec

def main():
    """ë©”ì¸ í•¨ìˆ˜"""
    # ì œëª©
    st.title("ğŸŒ¤ï¸ ì‹¤ì‹œê°„ ë‚ ì”¨")
    
    # íƒ­ ìƒì„±
    tab1, tab2 = st.tabs(["ğŸ” ë„ì‹œ ê²€ìƒ‰", "ğŸ“ ë‚´ ìœ„ì¹˜"])
    
    with tab1:
        # ë„ì‹œ ì…ë ¥
        col1, col2 = st.columns([3, 1])
        
        with col1:
            city_input = st.text_input("ë„ì‹œëª…", placeholder="ë„ì‹œëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: Seoul, Tokyo, London)", label_visibility="collapsed")
        
        with col2:
            search_btn = st.button("ğŸ” ê²€ìƒ‰", type="primary")
        
        # í•œêµ­ ì£¼ìš” ë„ì‹œ ë²„íŠ¼ë“¤
        st.markdown("**ğŸ‡°ğŸ‡· í•œêµ­ ì£¼ìš” ë„ì‹œ:**")
        korea_col1, korea_col2, korea_col3, korea_col4 = st.columns(4)
        
        with korea_col1:
            if st.button("ï¿½ï¸ ì„œìš¸", key="seoul"):
                city_input = "Seoul"
                search_btn = True
        with korea_col2:
            if st.button("âœˆï¸ ê¹€í¬", key="kimpo"):
                city_input = "Gimpo"
                search_btn = True
        with korea_col3:
            if st.button("ğŸŒŠ ë¶€ì‚°", key="busan"):
                city_input = "Busan"
                search_btn = True
        with korea_col4:
            if st.button("ï¿½ ì œì£¼", key="jeju"):
                city_input = "Jeju"
                search_btn = True
        
        # í•´ì™¸ ì£¼ìš” ë„ì‹œ ë²„íŠ¼ë“¤
        st.markdown("**ğŸŒ í•´ì™¸ ì£¼ìš” ë„ì‹œ:**")
        
        # ë„ì‹œ ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
        display_city_weather(search_btn, city_input)
    
    with tab2:
        # í˜„ì¬ ìœ„ì¹˜ ê¸°ë°˜ ë‚ ì”¨
        display_location_weather()

if __name__ == "__main__":
    main()